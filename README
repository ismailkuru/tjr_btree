-*- org -*-

~tjr_btree~, a CoW B-tree library

* Description

~tjr_btree~ is a B-tree library written in OCaml. The examples include
a simple on-disk key-value store.


* Examples

See ./examples e.g. ./examples/int_int_map_example_functionality.ml


* Introduction

The B-tree is a simple CoW B-tree. All sync-ed states are persistent
on disk (imagine that blocks are written once and then never mutated),
so operations such as "snapshot" are almost trivial.

The B-tree supports the usual operations: find, insert, delete.
In addition, there is an ~insert_many~ operation for inserting
multiple key-value pairs at once. This operation is more efficient
than repeatedly inserting. It is typically used when higher-level
operations are cached and then flushed all at once.

The routines are fully parameterized (e.g., by key and value type, key
order, store type etc). It is easy to have many B-trees using the same
store, even operating concurrently (although individual B-trees must
be updated sequentially at the moment).

The core is implemented in small-step operational style, with each
disk access corresponding to a separate step. Thus, it should be
feasible to introduce very fine-grained concurrency by interleaving
individual steps of each operation (where multiple operations execute
on different B-trees).

The core code is written in Isabelle/HOL and exported to OCaml
(although it could easily be implemented in any language because the
routines are very "concrete"). This repository contains the OCaml
wrapper round the core OCaml code extracted from Isabelle.


* Relation to ImpFS

ImpFS is a project to build an advanced high-performance filesystem.
~tjr_btree~ is one of the core libraries used by ImpFS.


* Installation

For the base system you need: 
- a basic Linux distribution (e.g. Ubuntu 16.04)
- ocaml and opam executables
- additional opam packages (see "Dependencies" below)
- additional "tjr" packages (see "Dependencies" below)

A simple install script is at
<https://github.com/tomjridge/tjr_imp_build_script>. That repository
also includes a Dockerfile.



* Documentation

ocamldoc is at https://tomjridge.github.io/tjr_imp_build_script/tjr_btree/Tjr_btree/index.html

The main documentation entry point is the module ~Tjr_btree_doc~. Please read the overview

https://tomjridge.github.io/tjr_imp_build_script/tjr_btree/Tjr_btree/Tjr_btree_doc/index.html


* Performance

Take this with a pinch of salt, but on an oldish SSD we can test
sequential writes:

#+BEGIN_SRC
$ examples $ int_int_map_main init ./btree.store
init ok

$ examples $ time int_int_map_main insert_range ./btree.store 1 1000000
insert_range ok

real  0m16.692s
user  0m16.597s
sys 0m0.092s

$ examples $ ls -alh btree.store 
-rw-r----- 1 tr61 tr61 75M Jan 28 14:32 btree.store
#+END_SRC

i.e., 1M sequential writes in 16.7s with a resulting store of sized 75M.

If we repeat this (i.e., another 1M random inserts, but this time on a
store that is already full), we get the same timings (but the store
size almost doubles).

For random writes:

#+BEGIN_SRC
$ examples $ time int_int_map_main test_random_writes ./btree.store 1 1000000 1000000
test_random_writes ok

real	0m37.182s
user	0m36.898s
sys	0m0.268s
#+END_SRC





* Dependencies

opam:

| yojson ppx_deriving_yojson |                                                 |
| core                       | bin_prot; timestamping, for performance testing |
| ppx_bin_prot               | marshalling via bin_prot, for testing           |
| extlib                     | pmap FIXME replace with tjr_polymap             |
| oseq                       | for examples involving inserting many entries   |

other:
| isa_btree     | Base OCaml defns extracted from Isabelle |
| tjr_fs_shared | Shared library for all fs stuff          |


old?:
| ocaml-compiler-libs |                |
| extunix             | provides fsync |
